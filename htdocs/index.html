<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Photo Booth</title>
    <style>
    	body {	background-color: #000; color: #FFF; 
	        font-family: sans-serif; font-size: 18pt; 
		margin:0; padding:0;
             }
	#imagediv { position:absolute; top:0; bottom:0; left:0; right:0; overflow:hidden; }
	.slides { display:block; position:absolute; min-width:100%; min-height:100%; }
	#info { display:none; position:absolute; left:1em; top:1em; font-size:15vh; color:#FFF; text-shadow: black 0.1vw 0.1vw 1vw; }
	#infodrawing { position:absolute; right:0; top:0; height:100%; display:none; }
	#countdown { position:absolute; text-align:center; right:0; left:0; width:100%; top:35%; font-size:20vh; color:#FFF; 
		text-shadow: black 0.1vw 0.1vw 1vw; display:none; }
	video { position:absolute; top:6vh; left:0; right:0; margin-left:auto; margin-right:auto; height:81vh; width:108vh; 
		border:1em solid white; border-bottom:2em solid white; transform: scaleX(-1);
		display:none; }
	#flash { position:absolute; right:0; left:0; bottom:0; top:0; display:none; background-color:#FFF; }
    </style>

    <script src="jquery/jquery.min.js"></script>
    <script>
	var slides=[];
	var interval=20000; // milli seconds
	var fadetime=1500; // milli seconds
	var loadwait=100; // milli seconds


	var current_slide=-1;
        var current_slide_element=0;
        var this_el;
        var other_el;

	function show_info(msg,autoaway)
	{
	    $("#info").text(msg).fadeIn(250);
	    if (autoaway) setTimeout(function () { $("#info").fadeOut(1000); },parseInt(autoaway)*1000);
	}

    // ---------------------------------------- webcam handling
	function hasGetUserMedia() 
	{
  	    return !!(navigator.getUserMedia);
	}

	var webcam_stream;
	function requestVideo()
	{
	    if (!hasGetUserMedia()) 
	    {
		show_info("Browser does not support WebRTC (Video)");
		return;
	    }
	    navigator.getUserMedia({video: true, audio: false},function(stream) {
    		var video = document.querySelector('video');
    		video.src = window.URL.createObjectURL(stream);
		webcam_stream=stream;
		webcam_active=true;
  	    }, function (e) { show_info("Connecting to WebRTC (video) failed "); console.log("webrtc",e); } );
	}

	var webcam_active=false;
	function toggle_webcam(mode)
	{
	    if (!webcam_active && (!mode || mode!="off"))
	    {
		requestVideo();
		$("video").fadeIn(300);
	    }
	    else 
	    {
		$("video").fadeOut(300,function () {
		    webcam_stream.getTracks()[0].stop();
		    $("video").attr("src","");
		    webcam_active=false;
		});
	    }
	}


    // -------------------------------------------- slide show
	var fliptimer=false;

	function load_slide_list()
	{
	    $.getJSON("images.json",function(data){
		slides=data;
		current_slide=-1;
		nextslide();
	    }).fail(function () {
		show_info("Loading image list failed!");
		current_slide=-1;
		nextslide();
	    });
	}

	function nextslide()
	{
	    if (fliptimer) clearTimeout(fliptimer);
	    nextslide_job();
	}

	function nextslide_job()
	{
	    fliptimer=false;
	    if (slides.length<1) show_info("No images found!"); // no images !

	    current_slide=current_slide+1
	    if (current_slide>=slides.length) // end of slides list, reload from server
	    {
	    	load_slide_list();
		return;
	    }
	    var tmp=this_el;
	    this_el=other_el;
	    other_el=tmp;
	    this_el.stop();
	    other_el.stop();

	    this_el.attr("src","images/"+slides[current_slide]);
	    setTimeout(function() {
		    this_el.fadeIn(fadetime);
		    var overflow_y=parseInt(this_el.css("height"))-parseInt($("#imagediv").css("height"));
		    var overflow_x=parseInt(this_el.css("width"))-parseInt($("#imagediv").css("width"));
		    if (overflow_x<0) overflow_x=0;
		    if (overflow_y<0) overflow_y=0;
		    if (overflow_x+overflow_y>0) this_el.animate({left:-overflow_x+"px",top:-overflow_y+"px"},interval-fadetime-100);
		    other_el.fadeOut(fadetime,function () { other_el.css({top:0,left:0}); });
	    },loadwait);
	    fliptimer=setTimeout(nextslide_job,interval);
	}


   // ----------------------------- info graphics
	var info_drawing_open=false;

	function hide_info_drawing()
	{
	    $("#infodrawing").fadeOut(800,function() { info_drawing_open=false; });
	}

	function show_info_drawing()
	{
	    if (!info_drawing_open)
	    {
		info_drawing_open=true;
		$("#infodrawing").fadeIn(800);
		setTimeout(hide_info_drawing,5000);
	    }
	}

    // ----------------------------- virtual camery mode

	function show_flash()
	{
	    $("#flash").show().fadeIn(200).fadeOut(300, function () {
		toggle_webcam("off");
	    });
	}

	function capture_photo() 
	{
	    setTimeout(show_flash,500);
	    $.getJSON("capture",function (data) {
		if (data.error) show_info(data.error,6);
		if (data.image) {
		    slides.splice(current_slide+1,0,data.image) 
		    nextslide();
		    show_info("Neues Photo!",3);
		}
	    });
	    countdown_running=false;
	}

	var countdown_running=false;

	function show_countdown()
	{
	    if (countdown_running) return;
	    countdown_running=true;
	    $("#countdown").text(3)
		.fadeIn(500).fadeOut(600,function() { $(this).text(2); })
		.fadeIn(500).fadeOut(600,function() { $(this).html("&#x1F603"); })
		.fadeIn(500).fadeOut(600,capture_photo);
	}


    // ----------------------------- gamepad handling

	var pollgamepad_interval=false;
	var pollgamepad_hold=false;

	function pollgamepad()
	{
	    var gps;
	    if (! "getGamepads" in navigator)
	    {
		clearInterval(pollgamepad_interval);
		alert("Browser does not support Gamepads");
		return;
	    }
 	    gps=navigator.getGamepads();
	    if (gps.length<0) return; 
	    gp=gps[0];
	    if (!gp || !gp.connected) return; 
	    
	    if (pollgamepad_hold) 
	    {
		if (gp.axes[0]==0 && gp.axes[1]==0 && !gp.buttons[0].pressed && !gp.buttons[1].pressed) pollgamepad_hold=false;
		return;
	    }
	    if (gp.axes[0]!=0 || gp.axes[1]!=0 || gp.buttons[2].pressed || gp.buttons[3].pressed) 
	    {
		// user moved stick or pressed other button;
		pollgamepad_hold=true;
		show_info_drawing();
	    }
	    if (gp.buttons[0].pressed) { pollgamepad_hold=true; toggle_webcam(); }
	    if (gp.buttons[1].pressed) { pollgamepad_hold=true; if (webcam_active) show_countdown(); else show_info_drawing(); }
	}


    // ----------------------------- main()
	$(document).ready(function(){
	    load_slide_list();
            this_el=$("#slide0");
            other_el=$("#slide1");
	    pollgamepad_interval=setInterval(pollgamepad,100);
	});
    </script>
</head>
<body>
   <div id=imagediv>
	<img id=slide0 class=slides>
   	<img id=slide1 class=slides>
   </div>
   <img id=infodrawing src=info-drawing.svg>
   <video autoplay></video>
   <div id=countdown></div>
   <div id=flash></div>
   <div id=info></div>
</body>
</html>
